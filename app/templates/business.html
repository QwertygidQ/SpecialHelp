{% extends "base.html" %}

{% block init %}
<!-- Bootstrap Rating CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-rating/1.5.0/bootstrap-rating.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-rating/1.5.0/bootstrap-rating.min.js"></script>

<!-- Leaflet CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>

<!-- Font Awesome CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- Initialization -->
<link rel="stylesheet" href="../static/css/stars.css">
<link rel="stylesheet" href="../static/css/map.css">

<script>
    let coords = [{{ business.latitude }}, {{ business.longitude }}];
    let zoom = 16;
</script>
<script src="../static/js/map_init.js"></script>
{% endblock %}

{% block content %}
<h1>{{ business.name }}</h1>

<div class="container">
    <div class="row">
        <div class="col-md-4 my-3">
            <img
                src="{{ url_for('uploads', filename=business.image.filename) if business.image is not none else '../static/images/default.png' }}"
                style="border-radius: 50%"
                class="img-fluid"/>
        </div>

        <div class="col-md-8 mb-3">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                {{ _('Address:') }}
                            </div>

                            <div class="card-body">
                                <p class="user-input">{{ business.address }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                {{ _('Tags:') }}
                            </div>

                            <div class="card-body">
                                {% for tag in business.tags %}
                                    <a
                                        href="{{ url_for('tag_list_page', tag_name=tag.name, page=1) }}"
                                        class="card-link">{{ tag.name }}</a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                {{ _('Working time:') }}
                            </div>

                            <div class="card-body">
                                <p class="user-input">{{ business.time }}</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                {{ _('Rating:') }}
                            </div>

                            <div class="card-body">
                                <input
                                    type="hidden"
                                    class="rating"
                                    value="{{ business.rating }}"
                                    data-filled="fa fa-2x fa-star checked"
                                    data-empty="fa fa-2x fa-star"
                                    data-readonly/>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                {{ _('Contacts:') }}
                            </div>

                            <div class="card-body">
                                <p class="user-input">{{ business.contacts }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header">
        {{ _('Description') }}
    </div>

    <div class="card-body">
        <p class="user-input">{{ business.desc }}</p>
    </div>
</div>

<div id="business_map" style="width: 100%; height: 300px;"></div>

{% if has_not_commented %}
    <div class="ui segment">
        <form class="ui bottom-padded form" method="post">
            {{ form.hidden_tag() }}

            <div class="field">
                {{ form.rating.label }}
                <div class="input-allowed ui large star rating" data-rating="{{ form.rating.data }}" data-max-rating="5"></div>
                {{ error_macro.print_errors(form.rating) }}
            </div>
            <div class="field">
                {{ form.comment.label }}
                {{ form.comment() }}
                {{ error_macro.print_errors(form.comment) }}
            </div>

            {{ form.submit(class_="ui button") }}
        </form>
    </div>
{% elif current_user.is_authenticated %} {# Authenticated user has already commented on this business #}
    <p>
        {{ _('Your comment has been posted!') }}
    </p>
{% else %}
    <p>
        {% autoescape false %}
        {{ _('%(link_and_babel_for_signin)s or %(link_and_babel_for_registration)s to post a comment!',
            link_and_babel_for_signin='<a href="{}">'.format(url_for('signin', next=request.path)) + _('Sign in to') + '</a>',
            link_and_babel_for_registration='<a href="{}">'.format(url_for('signup', next=request.path)) + _('Register to') + '</a>'
            ) }}
        {% endautoescape %}
    </p>
{% endif %}

{% if business.comments.all() %}
    <h2>{{ _('Comments') }}</h2>
{% endif %}

{% for comment in business.comments %}
    <div class="ui raised segment">
        <div class="ui stackable grid">
            <div class="three wide center aligned column">
                <div class="ui small bordered circular image">
                    <img src="{{ url_for('uploads', filename=comment.author.image.filename) if comment.author.image is not none else '../static/images/default.png' }}"/>
                </div>
            </div>

            <div class="thirteen wide column">
                <h2><a href="{{ url_for('profile', username=comment.author.username) }}">{{ comment.author.username }}</a></h2>
                <div class="input-disallowed ui large star rating" data-rating="{{ comment.rating }}" data-max-rating="5"></div>
                <p class="user-input">{{ comment.text }}</p>
            </div>
        </div>
    </div>
{% endfor %}

<div class="ui bottom-padded"></div>
{% endblock %}
